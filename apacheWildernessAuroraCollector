import sys
import datetime
from datetime import date, timedelta
import os
try:
    import urllib.request as urllib2
except ImportError:
    import urllib2
import pymysql
import codecs




# Get starting parameters form commandline args

datasource_id = str(sys.argv[1])
newDS         = int(datasource_id)
dateToStart   = str(sys.argv[2])
password      = str(sys.argv[3])




# varables that should not be re-instantiated within the loop
dateS = datetime.datetime(int(dateToStart[0:4]), int(dateToStart[4:-2]),
                          int(dateToStart[6:]))
print(dateS)
forge_id = 77
contact_person = 'msquire@elon.edu'

today = datetime.datetime.now()

# Make all of the database connections , cursor , and insert query




try:
    db1 = pymysql.connect(host='grid6.cs.elon.edu',
                          database='test',
                          user='gbatchelor',
                          password=password,
                          use_unicode=True,
                          charset='utf8')

except pymysql.Error as err:
    print(err)

cursor1 = db1.cursor()

insertQuery = "INSERT INTO `datasources1`(`datasource_id`,\
        `forge_id`,\
        `friendly_name`,\
        `date_donated`,\
        `contact_person`,\
        `comments`,\
        `start_date`,\
        `end_date`) VALUES (%s,%s,%s,%s,%s,%s,%s,%s)"


# make directory and save file
if not os.path.exists(datasource_id):
    os.mkdir(datasource_id)
    
    
    
    

"""

A loop that goes though the dates, 
pulls the HTML from the site 
writes it into the folder
inserting data into datasourses DB along the way

increments date

"""




while(dateS < today):
    print('Today= '+str(today))
    print('dateS= '+str(dateS))
    print(str(today-dateS))


    friendly_name = 'apache wilderness aurorra '+ str(dateS)
    
    
    dateSString = str(dateS)
    dateNoDashes= str(dateSString[0:4]+ dateSString[5:7]+
                          dateSString[8:10])
    print('date no dashes is::::  '+dateNoDashes)
    print("  ")
    fileLoc = datasource_id+"/"+dateNoDashes
    

        
    urlStem = 'http://wilderness.apache.org/channels/?f=aurora/'
    
    urlTail = str(dateS)
    
    fullUrl = urlStem + urlTail
    
    try:
        html = urllib2.urlopen(fullUrl).read()
        html2 = bytes.decode(html)
    except urllib2.HTTPError as error:
        print(error)
    else:
        outfile = codecs.open(fileLoc, 'w')
        outfile.write(str(html2))
        outfile.close()
          
    try:
        cursor1.execute(insertQuery, (newDS,
                    forge_id,
                    friendly_name,
                    datetime.datetime.now(),
                    'msquire@elon.edu',
                    fileLoc,
                    datetime.datetime.now(),
                    datetime.datetime.now()))
    except pymysql.Error as error:
        print(error)
        db1.rollback()

    dateS = dateS + timedelta(days=1)
    newDS += 1
    
db1.close()
cursor1.close()
